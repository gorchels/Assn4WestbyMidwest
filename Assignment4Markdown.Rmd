---
title: "Assignment4"
author: "Madeline Gorchels"
date: "11/10/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, comment = "")
```

```{r, echo=FALSE, message=FALSE}
#Loading packages and data sets (see note below)

library(tidyverse)
library(effsize)
library(knitr)
library(kableExtra)
library(vcdExtra) # Based on instructions it looks like this may be necissary -you'll need to instal this if you haven't already
library(car)
library(RColorBrewer)

lob_ab = read_csv("lobster_size_abundance.csv")
lob_trap = read_csv("lobster_traps.csv")

```

# "Lobster abundance and fishing pressure (2012 - 2017)"

Describe trends in lobster abundance (counts) and fishing pressure (trap buoys) at the five locations from
2012 - 2017. Ignore transect information - we are only interested in evaluating abundance and pressure on the
order of SITE. Note: you are not expected to use regression here - just think of ways to clearly
describe annual totals visually and in text, noting important trends, events and differences.


```{r}

tidy_lob_ab <- expand.dft(data.frame(lob_ab), freq = "COUNT") # Data in tidy format

# Histomgrams looking at size at each site

lob_ab_hist <- ggplot(tidy_lob_ab, aes(SIZE)) +
  geom_histogram(aes(fill = SITE)) +
  facet_wrap(~SITE)

lob_ab_hist #data normally distributed can do ANOVA

lob_ab_hist_stack <- ggplot(tidy_lob_ab, aes(SIZE)) +
  geom_histogram(aes(fill = SITE)) 

lob_ab_hist_stack
```

```{r}

# These graphs are plotting size of lobsters at each site based on year

lob_ab_year <- group_by(tidy_lob_ab, "YEAR") 

# Plotting changes in time for AQUE
aque_ab_summary <- filter(lob_ab_year, SITE == "AQUE") %>% 
  group_by(YEAR) %>% 
  summarize( 
   mean_size_aque = round(mean(SIZE), 2))

aque_lob_ab_hist <- ggplot(data = aque_ab_summary, 
                           aes(x = YEAR,
                               y = mean_size_aque)) +
  geom_col()

aque_lob_ab_hist


# Plotting changes in time for CARP
CARP_ab_summary <- filter(lob_ab_year, SITE == "CARP") %>% 
  group_by(YEAR) %>% 
  summarize( 
   mean_size_CARP = round(mean(SIZE), 2))

CARP_lob_ab_hist <- ggplot(data = CARP_ab_summary, 
                           aes(x = YEAR,
                               y = mean_size_CARP)) +
  geom_col()

CARP_lob_ab_hist


# Plotting changes in time for IVEE
IVEE_ab_summary <- filter(lob_ab_year, SITE == "IVEE") %>% 
  group_by(YEAR) %>% 
  summarize( 
   mean_size_IVEE = round(mean(SIZE), 2))

IVEE_lob_ab_hist <- ggplot(data = IVEE_ab_summary, 
                           aes(x = YEAR,
                               y = mean_size_IVEE)) +
  geom_col()

IVEE_lob_ab_hist


# Plotting changes in time for MOHK
MOHK_ab_summary <- filter(lob_ab_year, SITE == "MOHK") %>% 
  group_by(YEAR) %>% 
  summarize( 
   mean_size_MOHK = round(mean(SIZE), 2))

MOHK_lob_ab_hist <- ggplot(data = MOHK_ab_summary, 
                           aes(x = YEAR,
                               y = mean_size_MOHK)) +
  geom_col()

MOHK_lob_ab_hist



# Plotting changes in time for NAPL
NAPL_ab_summary <- filter(lob_ab_year, SITE == "NAPL") %>% 
  group_by(YEAR) %>% 
  summarize( 
   mean_size_NAPL = round(mean(SIZE), 2))

NAPL_lob_ab_hist <- ggplot(data = NAPL_ab_summary, 
                           aes(x = YEAR,
                               y = mean_size_NAPL)) +
  geom_col()

NAPL_lob_ab_hist
```




```{r}
# Trap data has other sites, this code is to look at only the sites in the other table

lob_trap_filtered <- filter(lob_trap, SITE == c("AQUE","CARP","IVEE","MOHK","NAPL"))  # I get a warning message so I need to confirm this is ok

# Hist looks at the number of traps per transect at each site
lob_trap_hist <- ggplot(lob_trap_filtered, aes(TRAPS)) +
  geom_histogram(aes(fill = SITE)) +
  facet_wrap(~SITE, scales = "free")

lob_trap_hist

```


```{r}
# These graphs look at the mean number of traps at sites over time

lob_trap_year <- group_by(lob_trap_filtered, "YEAR") 

# Plotting changes in time for AQUE
aque_trap_summary <- filter(lob_trap_year, SITE == "AQUE") %>% 
  group_by(YEAR) %>% 
  summarize( 
   mean_trap_aque = round(mean(TRAPS), 2))

aque_lob_trap_hist <- ggplot(data = aque_trap_summary, 
                           aes(x = YEAR,
                               y = mean_trap_aque)) +
  geom_col()

aque_lob_trap_hist



# Plotting changes in time for CARP
CARP_trap_summary <- filter(lob_trap_year, SITE == "CARP") %>% 
  group_by(YEAR) %>% 
  summarize( 
   mean_trap_CARP = round(mean(TRAPS), 2))

CARP_lob_trap_hist <- ggplot(data = CARP_trap_summary, 
                           aes(x = YEAR,
                               y = mean_trap_CARP)) +
  geom_col()

CARP_lob_trap_hist



# Plotting changes in time for IVEE
IVEE_trap_summary <- filter(lob_trap_year, SITE == "IVEE") %>% 
  group_by(YEAR) %>% 
  summarize( 
   mean_trap_IVEE = round(mean(TRAPS), 2))

IVEE_lob_trap_hist <- ggplot(data = IVEE_trap_summary, 
                           aes(x = YEAR,
                               y = mean_trap_IVEE)) +
  geom_col()

IVEE_lob_trap_hist



# Plotting changes in time for MOHK
MOHK_trap_summary <- filter(lob_trap_year, SITE == "MOHK") %>% 
  group_by(YEAR) %>% 
  summarize( 
   mean_trap_MOHK = round(mean(TRAPS), 2))

MOHK_lob_trap_hist <- ggplot(data = MOHK_trap_summary, 
                           aes(x = YEAR,
                               y = mean_trap_MOHK)) +
  geom_col()

MOHK_lob_trap_hist




# Plotting changes in time for NAPL
NAPL_trap_summary <- filter(lob_trap_year, SITE == "NAPL") %>% 
  group_by(YEAR) %>% 
  summarize( 
   mean_trap_NAPL = round(mean(TRAPS), 2))

NAPL_lob_trap_hist <- ggplot(data = NAPL_trap_summary, 
                           aes(x = YEAR,
                               y = mean_trap_NAPL)) +
  geom_col()

NAPL_lob_trap_hist
```

```{r}
# These graphs look at total traps at each location over time

# Plotting changes in time for AQUE
aque_trap_total <- filter(lob_trap_year, SITE == "AQUE") %>% 
  group_by(YEAR) 

aque_lob_trap_total_hist <- ggplot(data = aque_trap_total, 
                           aes(x = YEAR,
                               y = TRAPS)) +
  geom_col()

aque_lob_trap_total_hist



# Plotting changes in time for CARP
CARP_trap_total <- filter(lob_trap_year, SITE == "CARP") %>% 
  group_by(YEAR) 

CARP_lob_trap_total_hist <- ggplot(data = CARP_trap_total, 
                           aes(x = YEAR,
                               y = TRAPS)) +
  geom_col()

CARP_lob_trap_total_hist



# Plotting changes in time for IVEE
IVEE_trap_total <- filter(lob_trap_year, SITE == "IVEE") %>% 
  group_by(YEAR) 

IVEE_lob_trap_total_hist <- ggplot(data = IVEE_trap_total, 
                           aes(x = YEAR,
                               y = TRAPS)) +
  geom_col()

IVEE_lob_trap_total_hist



# Plotting changes in time for MOHK
MOHK_trap_total <- filter(lob_trap_year, SITE == "MOHK") %>% 
  group_by(YEAR) 

MOHK_lob_trap_total_hist <- ggplot(data = MOHK_trap_total, 
                           aes(x = YEAR,
                               y = TRAPS)) +
  geom_col()

MOHK_lob_trap_total_hist




# Plotting changes in time for NAPL
NAPL_trap_total <- filter(lob_trap_year, SITE == "NAPL") %>% 
  group_by(YEAR) 

NAPL_lob_trap_total_hist <- ggplot(data = NAPL_trap_total, 
                           aes(x = YEAR,
                               y = TRAPS)) +
  geom_col()

NAPL_lob_trap_total_hist
```

```{r}
# Trying to create a plot using data from both datasets

traps_merge <- group_by(lob_trap_year, YEAR, SITE) %>% 
  summarize(
    total_traps = sum(TRAPS)
  )
  
ab_merge  <- group_by(lob_ab_year, YEAR, SITE) %>% 
   summarize(
    total_lob = length(SIZE)
  )

ab_traps_merge <- merge(traps_merge,ab_merge, by=c("YEAR","SITE")) 


count_vs_traps <- ggplot(data = ab_traps_merge, 
                           aes(x = total_traps,
                               y = total_lob)) +
  geom_point(aes(colour = SITE)) +
  facet_wrap(~YEAR)

count_vs_traps

```



# "Compare mean lobster size by site in 2017"

```{r}
lob_size_2017 <- select(tidy_lob_ab, YEAR, SITE, SIZE) %>%  # Select relevant categories. Note, depending on how the we make the file tidy, the first term may need to change 
  filter(YEAR == "2017") %>% 
  group_by(SITE)

#Exploritory graphs to test normality of data
lob_2017_hist <- ggplot(lob_size_2017, aes(x = SIZE)) +
  geom_histogram(aes(fill = SITE)) +
  facet_wrap(~ SITE)

lob_2017_hist

lob_2017_qq <- ggplot(lob_size_2017, aes(sample = SIZE)) +
  geom_qq() +
  facet_wrap(~ SITE)
lob_2017_qq

#data normally distributed 

lob_var <- leveneTest(SIZE ~ SITE, data = lob_size_2017)
lob_var
#variances not equal

var <- lob_size_2017 %>% 
  group_by(SITE) %>% 
  summarize(variance = var(SIZE))
var
#but largest variance is still within the standard amount, so on to ANOVA

#H0: Mean lobster size accross site equal
#HA: At least two mean differ significantly accross sites

lob_2017_aov <- aov(SIZE ~ SITE, data = lob_size_2017)
summary(lob_2017_aov)
#reject null at least two sites significantly different lobster sizes

# Post-hoc testing with Tukey's HSD
lob_2017_ph <- TukeyHSD(lob_2017_aov)
lob_2017_ph

#2017 sites signficantly different from one anothe NAPL to CARP, NAPL to IVEE, and NAPL to MOHK
```

# Changes in lobster size at MPA and non-MPA sites in 2012 and 2017


4. Doing a chi squared analysis on the size of lobsters based off site in 2017

```{r}
#Making a table that is chi-squared friendly 

legal_lob = tidy_lob_ab %>% 
  filter(YEAR == 2017) %>% 
  mutate(
    legal = case_when(
      SIZE > 82.6 ~ "Above Limit",
      SIZE <= 82.6 ~ "Below Limit")) %>% 
  count(SITE, legal) %>% 
  spread(legal, n) %>% 
  select(-SITE)

#View(legal_lob)

rownames(legal_lob) =c("AQUE", "CARP", "IVEE", "MOHK", "NAPL")

#Making a gross propotion table for viewing pleasure 

legal_prop = prop.table(as.matrix(legal_lob), 1)
legal_prop

#Preforming a chi-square 

legal_x2 = chisq.test(legal_lob)
legal_x2

#Hmmm, I'm thinking it will be more meaningful to group by protected and non protected sites. I'm going to test this with an additional dataframe. 


```
```{r}
#I'm doing a chisquared test comparing protected and non protected sites. 

legal_lob_prot = tidy_lob_ab %>% 
  filter(YEAR == 2017) %>% 
  mutate(
    legal = case_when(
      SIZE > 82.6 ~ "Above Limit",
      SIZE <= 82.6 ~ "Below Limit")) %>%
  mutate(
    prot = case_when(
      SITE == "NAPL" ~ "Protected",
      SITE == "IVEE" ~ "Protected", 
      SITE == "AQUE" ~ "Unprotected",
      SITE == "MOHK" ~ "Unprotected",
      SITE == "CARP" ~ "Unprotected"
    )
  ) %>% 
  count(prot, legal) %>% 
  spread(legal, n) %>% 
  select(-prot)

#View(legal_lob_prot)

rownames(legal_lob_prot) =c("Protected", "Unprotected")

#Making a gross propotion table for viewing pleasure 

legal_prot_prop = prop.table(as.matrix(legal_lob_prot), 1)
legal_prot_prop

#Preforming a chi-square 

legal_prot_x2 = chisq.test(legal_lob_prot)
legal_prot_x2

#P value is 0.97, so there is definitely not significant difference between protected and unprotected sites. This is pretty obvious from the quick and dirty propotion table I made. 
```

